LATEXMK_OPTIONS := -synctex=1 $\
				   -interaction=nonstopmode $\
				   -recorder $\
				   -file-line-error $\
				   -shell-escape $\
				   -halt-on-error
CHKTEX_OPTIONS := --localrc ./.chktexrc $\
				  --headererr $\
				  --inputfiles $\
				  --format=1 $\
				  --verbosity=2
LATEXINDENT_OPTIONS := --local=indentconfig.yaml $\
					   --overwrite

all:
	latexmk $(LATEXMK_OPTIONS) -pdf main.tex

clean:
	for file in $(shell find . -regex ".*\.\(tex\)\$$"); do \
		DIR=`dirname $$file`; \
		latexmk -C -outdir=$$DIR $$file; \
	done

cleanaux:
	for file in $(shell find . -regex ".*\.\(tex\)\$$"); do \
		DIR=`dirname $$file`; \
		latexmk -c -outdir=$$DIR $$file; \
	done

# remove backup files that generated by latexindent.pl
cleanbak:
	rm -f $(shell find . -regex ".*\.\(bak\d*\|log\)$$")

chktex:
	chktex $(CHKTEX_OPTIONS) $(shell find . -name "*.tex")

# format tex, cls, sty files
# all files and directories should not contain any white space in their names
formatall:
	for file in $(shell find . -regex ".*\.\(tex\|cls\|sty\)\$$"); do \
		echo "\nFormatting $$file ...\n"; \
		latexindent $(LATEXINDENT_OPTIONS) $$file; \
	done

options:
	@echo $(LATEXMK_OPTIONS)
	@echo $(LATEXINDENT_OPTIONS)

updatecls:
	mkdir -p $(shell kpsewhich -var-value=TEXMFHOME)/tex/latex/local/class
	cp *.cls $(shell kpsewhich -var-value=TEXMFHOME)/tex/latex/local/class

%.pdf: %.tex
	latexmk $(LATEXMK_OPTIONS) -pdf -pvc -outdir=$(shell dirname $<) $<

%.dvi: %.tex
	latexmk $(LATEXMK_OPTIONS) -dvi -pvc -outdir=$(shell dirname $<) $<

%.ps: %.tex
	latexmk $(LATEXMK_OPTIONS) -ps -pvc -outdir=$(shell dirname $<) $<

%.pdf.o: %.tex
	latexmk $(LATEXMK_OPTIONS) -pdf -outdir=$(shell dirname $<) $<

%.dvi.o: %.tex
	latexmk $(LATEXMK_OPTIONS) -dvi -outdir=$(shell dirname $<) $<

%.ps.o: %.tex
	latexmk $(LATEXMK_OPTIONS) -ps -outdir=$(shell dirname $<) $<

# remove auxiliary files and pdf, dvi files
%.clean: %.tex
	latexmk -C -outdir=$(shell dirname $<) $<

# remove auxiliary files that generated while latexmk running
%.cleanaux: %.tex
	latexmk -c -outdir=$(shell dirname $<) $<
